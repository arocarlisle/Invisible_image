<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <meta charset="utf-8" />
    <title>隱形圖片 線上轉換</title>

    <style type="text/css">
        html, body {
            margin: 0px;
            padding: 0px;
        }

        html {
            background-color: rgb(30, 30, 30);
            font-family: "微軟正黑體";
            color: #FFF;
            margin: 5px;
            transition:    background-color 1s ;
        }

        canvas {
            width: 0px;
            height: 0px;
        }

        table {
            border: 1px solid #808080;
            border-collapse: collapse;
        }

        tr, td {
            border: 1px solid #808080;
        }

        td {
            text-align: center;
            font-size: 20px;
            padding: 10px;
        }

        .but {
            padding: 10px;
            color: #FFF;
            background-color: rgb(0, 148, 255);
            font-size: 20px;
            display: inline-block;
        }

            .but:active {
                background-color: rgb(167, 0, 255);
            }

        input[type=checkbox] {
            transform: scale(1.5);
        }

        a[href] {
            color: rgb(15, 189, 255) !important;
        }
    </style>



</head>
<body>


    <div onclick='document.getElementById("file_input").click()' class="but">開啟圖片</div>
    <input style="display:none" type="file" id="file_input" accept="image/*" />
    <br>
    <br>
    <label><input type="checkbox" id="ch_reverse"><a style="font-size:20px;"> 反轉顏色　</a></label>
 
    <label><input type="checkbox" id="ch_max_1000" /><a style="font-size:20px;"> 最大限制1000px　</a></label>

    <label><input type="checkbox" id="bac_white" /><a style="font-size:20px;">開燈</a></label>

    <br><br>


    <table id="table" style="width:100%;display:none;" border="1">
        <tr style="width:100%">
            <td width="50%">原圖</td>
            <td width="50%">轉換後</td>
        </tr>
        <tr style="width:100%">
            <td width="50%">
                <img id="img" style="width:100%" />
            </td>
            <td width="50%">
                <img id="img2" style="width:100%" />
            </td>
        </tr>
    </table>

    <canvas id="can"> </canvas>
    <canvas id="can_2"> </canvas>





    <br>
    說明：將圖片轉換成單色的半透明隱形圖片。<br>

    <ul>
        <li>
            作者：<a href="https://home.gamer.com.tw/homeindex.php?owner=hbl917070" target="_blank">hbl917070 (深海異音)</a>
        </li>
        <li>如果是手機，盡量不要丟很大的圖片然後又把最大限制的勾拿掉，不然可能會讓瀏覽器閃退。</li>
        <li>電腦版右鍵儲存圖片；手機版長按圖片儲存。</li>
    </ul>








    <script>

        window.onload = function () {

            //開燈或關燈
            document.getElementById("bac_white").onchange = function (e) {
                var obj_html = document.getElementsByTagName("html")[0];

                if (document.getElementById("bac_white").checked) {
                    obj_html.style.backgroundColor = "#fff";
                    obj_html.style.color = "#000";
                } else {
                    obj_html.style.backgroundColor = "rgb(30, 30, 30)";
                    obj_html.style.color = "#fff";
                }
            }


            //初始化
            document.getElementById("ch_reverse").checked = false;
            document.getElementById("ch_max_1000").checked = true;
            document.getElementById("bac_white").checked = false;
            
            



            //選取圖片
            var input = document.getElementById("file_input");

            if (typeof FileReader === 'undefined') {
                alert("抱歉，你的瀏覽器不支持 FileReader");
                input.setAttribute('disabled', 'disabled');
            } else {
                input.addEventListener('change', readFile, false);
            }



            function readFile() {
                var file = this.files[0];
                if (!/image\/\w+/.test(file.type)) {
                    alert("文件必須為圖片！");
                    return false;
                }
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (e) {
                    var src = this.result;//把載入的檔案變成圖片網址

                    fun_載入圖片(src);
                    document.getElementById("table").style.display = "table";//第一次執行後就顯示輸出結果

                }
            }

        }


        //
        //
        //
        function fun_載入圖片(src) {

            //var obj_img = document.getElementById("img");//載入圖片
            var obj_img = document.createElement("img");

            obj_img.src = src;
            obj_img.onload = function () {


                var wid = obj_img.naturalWidth;
                var hei = obj_img.naturalHeight;


                //避免圖太大
                var max_size = 1000;
                if (document.getElementById("ch_max_1000").checked) {//如果圖片太大，就先縮小在進行轉換

                    if (wid > max_size || hei > max_size) {
                        var w01 = wid / max_size;
                        var h01 = hei / max_size;

                        if (w01 > h01) {
                            wid = wid / w01;
                            hei = hei / w01;
                        } else {
                            wid = wid / h01;
                            hei = hei / h01;
                        }
                    }

                    //設定canvas物件
                    var can = document.getElementById("can");
                    can.width = wid;
                    can.height = hei;
                    c = can.getContext("2d");
                    c.drawImage(obj_img, 0, 0, wid, hei);
                    obj_img.src = can.toDataURL('image/png', 0.8);//輸出成圖片

                    obj_img.onload = function () {

                        fun(obj_img);//圖片載入完成後執行轉換
                        document.getElementById("img").src = src;

                    }

                } else {//不縮小圖片直接進行轉換

                    fun(obj_img);//圖片載入完成後執行轉換
                    document.getElementById("img").src = src;
                }



                document.getElementById("file_input").value = "";//避免無法開啟相同的圖片

            }

        }

        ///
        /// 執行轉換
        ///
        function fun(obj_img) {

            //取得圖片物件
            //var obj_img = document.getElementById("img");
            var wid = obj_img.naturalWidth;
            var hei = obj_img.naturalHeight;


            //設定canvas物件
            var can = document.getElementById("can");
            can.width = wid;
            can.height = hei;

            c = can.getContext("2d");
            c.drawImage(obj_img, 0, 0, wid, hei);


            var can_2 = document.getElementById("can_2");
            can_2.width = wid;
            can_2.height = hei;

            c_2 = can_2.getContext("2d");





            //轉換
            var s = c.getImageData(0, 0, wid, hei);
            var r = c.createImageData(wid, hei);

            var bool_反轉 = document.getElementById("ch_reverse").checked;

            for (var i = 0; i < wid; i++) {
                for (var j = 0; j < hei; j++) {

                    var k = (wid * j + i) * 4;
                    r.data[k + 0] = 255;//r
                    r.data[k + 1] = 255;//g
                    r.data[k + 2] = 255;//b
                    //r.data[k + 3] = s.data[k];//使用r來判斷深淺

                    var gray = (s.data[0] + s.data[k + 1] + s.data[k + 2]) / 3;//灰階
                    if (bool_反轉) {
                        r.data[k + 3] = 255 - gray;//a
                    } else {
                        r.data[k + 3] = gray;//a
                    }


                }

            }

            c_2.putImageData(r, 0, 0);//繪製canvas
            document.getElementById("img2").src = can_2.toDataURL('image/png', 0.8);//輸出成圖片




        }




    </script>

</body>
</html>